/**
 * sofa-user-service - v0.7.1 - Thu Apr 23 2015 12:35:54 GMT+0200 (CEST)
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(e){"use strict";e.define("sofa.LeasedObject",function(t,n){var r={},s=n||(new Date).getTime();r.unwrap=function(n){return e.Util.isUndefined(n)?t:o(s,n)?t:null},r.serialize=function(){return{data:t,timestamp:s}};var i=function(e){return Math.floor(e/1e3/60)},o=function(e,t){var n=i(e),r=i((new Date).getTime());return t>=r-n};return r}),e.LeasedObject.deserialize=function(t){return new e.LeasedObject(t.data,t.timestamp)},e.define("sofa.UserService",function(t,n,r,s){var i={},o={"Content-Type":"application/x-www-form-urlencoded"},a="basketService_",d=a+"invoiceAddress",u=a+"shippingAddress",c=a+"loggedInUser",g=n.get("apiEndpoint")+"customers/login",f=n.get("storeCode"),l=null;return i.getInvoiceAddress=function(r){var s=t.get(d);return s?e.LeasedObject.deserialize(s).unwrap(r)||{}:(s={country:n.getDefaultCountry()},i.updateInvoiceAddress(s),s)},i.updateInvoiceAddress=function(n){return t.set(d,new e.LeasedObject(n).serialize())},i.hasExistingAddress=function(e){return!!t.get(e)},i.hasExistingShippingAddress=function(){return i.hasExistingAddress(u)},i.hasExistingInvoiceAddress=function(){return i.hasExistingAddress(d)},i.getShippingAddress=function(n){var r=t.get(u);return r?e.LeasedObject.deserialize(r).unwrap(n)||{}:{}},i.updateShippingAddress=function(n){return t.set(u,new e.LeasedObject(n).serialize())},i.login=function(n,a){var d=s.defer();return r({method:"POST",url:g,headers:o,transformRequest:e.Util.toFormData,data:{storeCode:f,user:n,password:a}}).then(function(e){l=e.data,t.set(c,l),d.resolve(l)},function(){i.logout(),d.reject()}),d.promise},i.isLoggedIn=function(){return l||(l=t.get(c)),!!l},i.logout=function(){t.remove(c),l=null},i.getEmail=function(){if(!i.isLoggedIn())throw new Error("Can't access email address, user is not logged in!");var e=l||t.get(c);return e.customer.email},i.getAddresses=function(){if(!i.isLoggedIn())throw new Error("Can't access addresses, user is not logged in!");var e=l||t.get(c);return e.customer.addresses},i})}(sofa,document);