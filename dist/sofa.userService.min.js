/**
 * sofa-user-service - v0.5.1 - 2015-02-18
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a){"use strict";a.define("sofa.LeasedObject",function(b,c){var d={},e=c||(new Date).getTime();d.unwrap=function(c){return a.Util.isUndefined(c)?b:g(e,c)?b:null},d.serialize=function(){return{data:b,timestamp:e}};var f=function(a){return Math.floor(a/1e3/60)},g=function(a,b){var c=f(a),d=f((new Date).getTime());return b>=d-c};return d}),a.LeasedObject.deserialize=function(b){return new a.LeasedObject(b.data,b.timestamp)},a.define("sofa.UserService",function(b,c,d,e){var f={},g={"Content-Type":"application/x-www-form-urlencoded"},h="basketService_",i=h+"invoiceAddress",j=h+"shippingAddress",k=h+"loggedInUser",l=c.get("apiEndpoint")+"customers/login",m=c.get("storeCode"),n=null;return f.getInvoiceAddress=function(d){var e=b.get(i);return e?a.LeasedObject.deserialize(e).unwrap(d)||{}:(e={country:c.getDefaultCountry()},f.updateInvoiceAddress(e),e)},f.updateInvoiceAddress=function(c){return b.set(i,new a.LeasedObject(c).serialize())},f.hasExistingAddress=function(a){return!!b.get(a)},f.hasExistingShippingAddress=function(){return f.hasExistingAddress(j)},f.hasExistingInvoiceAddress=function(){return f.hasExistingAddress(i)},f.getShippingAddress=function(c){var d=b.get(j);return d?a.LeasedObject.deserialize(d).unwrap(c)||{}:{}},f.updateShippingAddress=function(c){return b.set(j,new a.LeasedObject(c).serialize())},f.login=function(c,h){var i=e.defer();return d({method:"POST",url:l,headers:g,transformRequest:a.Util.toFormData,data:{storeCode:m,user:c,password:h}}).then(function(a){n=a.data,b.set(k,n),i.resolve(n)},function(){f.logout(),i.reject()}),i.promise},f.isLoggedIn=function(){return n||(n=b.get(k)),!!n},f.logout=function(){b.remove(k),n=null},f.getEmail=function(){if(!f.isLoggedIn())throw new Error("Can't access email address, user is not logged in!");var a=n||b.get(k);return a.customer.email},f.getAddresses=function(){if(!f.isLoggedIn())throw new Error("Can't access addresses, user is not logged in!");var a=n||b.get(k);return a.customer.addresses},f})}(sofa);